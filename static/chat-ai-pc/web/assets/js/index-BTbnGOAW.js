var Be=Object.defineProperty;var He=(e,t,s)=>t in e?Be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var B=(e,t,s)=>(He(e,typeof t!="symbol"?t+"":t,s),s);import{j as H,w as X,b as ue,o as Ce,k as O,q as Me,r as M,g as De,t as Te,f as ae,I as xe,y as Oe,z as T,D as E,E as S,u as P,J as re,K,G as fe,L as me,M as Ee,N as Ue,n as pe,e as ge,O as ie,P as qe,A as ze,Q as Ve,S as Je,x as We}from"./vue-chunks-bivF63W1.js";import{c as Ke,p as Ge,m as te,n as se,A as Qe,i as ve,I as Xe,L as Ye,C as Ze,e as Ie,s as et,D as tt,d as st,S as he,v as _e,y as ot,E as Le,F as z}from"../../index.js";import{a as nt}from"./axios-B4uVmeYG.js";import{q as at}from"./qs-DrHefV6n.js";import{P as rt,m as it,b as lt}from"./mount-component-edKf3uo_.js";import"./dayjs-C4iS2aBk.js";import"./crypto-js-BJ7SvduI.js";let J=0;function ct(e){e?(J||document.body.classList.add("van-toast--unclickable"),J++):J&&(J--,J||document.body.classList.remove("van-toast--unclickable"))}const[ut,D]=Ke("toast"),dt=["show","overlay","teleport","transition","overlayClass","overlayStyle","closeOnClickOverlay","zIndex"],ft={icon:String,show:Boolean,type:te("text"),overlay:Boolean,message:se,iconSize:se,duration:Qe(2e3),position:te("middle"),teleport:[String,Object],wordBreak:String,className:ve,iconPrefix:String,transition:te("van-fade"),loadingType:String,forbidClick:Boolean,overlayClass:ve,overlayStyle:Object,closeOnClick:Boolean,closeOnClickOverlay:Boolean,zIndex:se};var Ae=H({name:ut,props:ft,emits:["update:show"],setup(e,{emit:t,slots:s}){let o,n=!1;const a=()=>{const m=e.show&&e.forbidClick;n!==m&&(n=m,ct(n))},r=m=>t("update:show",m),l=()=>{e.closeOnClick&&r(!1)},c=()=>clearTimeout(o),f=()=>{const{icon:m,type:g,iconSize:_,iconPrefix:u,loadingType:v}=e;if(m||g==="success"||g==="fail")return O(Xe,{name:m||g,size:_,class:D("icon"),classPrefix:u},null);if(g==="loading")return O(Ye,{class:D("loading"),size:_,type:v},null)},p=()=>{const{type:m,message:g}=e;if(s.message)return O("div",{class:D("text")},[s.message()]);if(Ze(g)&&g!=="")return m==="html"?O("div",{key:0,class:D("text"),innerHTML:String(g)},null):O("div",{class:D("text")},[g])};return X(()=>[e.show,e.forbidClick],a),X(()=>[e.show,e.type,e.message,e.duration],()=>{c(),e.show&&e.duration>0&&(o=setTimeout(()=>{r(!1)},e.duration))}),ue(a),Ce(a),()=>O(rt,Me({class:[D([e.position,e.wordBreak==="normal"?"break-normal":e.wordBreak,{[e.type]:!e.icon}]),e.className],lockScroll:!1,onClick:l,onClosed:c,"onUpdate:show":r},Ge(e,dt)),{default:()=>[f(),p()]})}});const mt={icon:"",type:"text",message:"",className:"",overlay:!1,onClose:void 0,onOpened:void 0,duration:2e3,teleport:"body",iconSize:void 0,iconPrefix:void 0,position:"middle",transition:"van-fade",forbidClick:!1,loadingType:void 0,overlayClass:"",overlayStyle:void 0,closeOnClick:!1,closeOnClickOverlay:!1};let G=[],pt=!1,ye=Ie({},mt);const gt=new Map;function vt(e){return tt(e)?e:{message:e}}function ht(){const{instance:e,unmount:t}=it({setup(){const s=M(""),{open:o,state:n,close:a,toggle:r}=lt(),l=()=>{},c=()=>O(Ae,Me(n,{onClosed:l,"onUpdate:show":r}),null);return X(s,f=>{n.message=f}),De().render=c,{open:o,close:a,message:s}}});return e}function _t(){if(!G.length||pt){const e=ht();G.push(e)}return G[G.length-1]}function Y(e={}){if(!et)return{};const t=_t(),s=vt(e);return t.open(Ie({},ye,gt.get(s.type||ye.type),s)),t}st(Ae);const yt=0,bt="application/x-www-form-urlencoded;charset=UTF-8",wt=5*60*1e3,le=new URL("/assets/img/user_avatar_2x-D7HF6Y-m.png",import.meta.url).href,kt=new URL("data:image/svg+xml,%3csvg%20width='62'%20height='62'%20viewBox='0%200%2062%2062'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3ccircle%20cx='31'%20cy='31'%20r='31'%20fill='url(%23paint0_linear_930_6995)'/%3e%3cpath%20d='M39%2036.3346C41.9455%2036.3346%2044.3333%2033.9468%2044.3333%2031.0013C44.3333%2028.0558%2041.9455%2025.668%2039%2025.668'%20stroke='%23F2F4FF'%20stroke-width='2.66667'%20stroke-linejoin='round'/%3e%3cpath%20d='M23.0013%2025.668C20.0558%2025.668%2017.668%2028.0558%2017.668%2031.0013C17.668%2033.9468%2020.0558%2036.3346%2023.0013%2036.3346'%20stroke='%23F2F4FF'%20stroke-width='2.66667'%20stroke-linejoin='round'/%3e%3cpath%20d='M23%2036.3346V36.0013V34.3346V31.0013V25.668C23%2021.2497%2026.5817%2017.668%2031%2017.668C35.4183%2017.668%2039%2021.2497%2039%2025.668V36.3346C39%2040.7529%2035.4183%2044.3346%2031%2044.3346'%20stroke='%23F2F4FF'%20stroke-width='2.66667'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3cdefs%3e%3clinearGradient%20id='paint0_linear_930_6995'%20x1='31'%20y1='0'%20x2='31'%20y2='62'%20gradientUnits='userSpaceOnUse'%3e%3cstop%20stop-color='%23336DFF'/%3e%3cstop%20offset='1'%20stop-color='%23495EFF'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",import.meta.url).href;function Pe(e,t){if(t)try{t=JSON.parse(JSON.stringify(t))}catch(s){console.error("Failed to stringify data:",s);return}if(window.parent&&typeof window.parent.postMessage=="function")try{window.parent.postMessage({action:e,data:t},"*")}catch(s){console.error("Failed to post message:",s)}else console.warn("window.parent is not available or postMessage is not supported.")}function St(e){Pe("init",e)}function Ct(){Pe("closeChat")}async function Mt(e,t){const s=e.getReader();let o;for(;!(o=await s.read()).done;)t(o.value)}function Tt(e){let t,s,o,n=!1;return function(r){t===void 0?(t=r,s=0,o=-1):t=Ot(t,r);const l=t.length;let c=0;for(;s<l;){n&&(t[s]===10&&(c=++s),n=!1);let f=-1;for(;s<l&&f===-1;++s)switch(t[s]){case 58:o===-1&&(o=s-c);break;case 13:n=!0;case 10:f=s;break}if(f===-1)break;e(t.subarray(c,f),o),c=s,o=-1}c===l?t=void 0:c!==0&&(t=t.subarray(c),s-=c)}}function xt(e,t,s){let o=be();const n=new TextDecoder;return function(r,l){if(r.length===0)s==null||s(o),o=be();else if(l>0){const c=n.decode(r.subarray(0,l)),f=l+(r[l+1]===32?2:1),p=n.decode(r.subarray(f));switch(c){case"data":o.data=o.data?o.data+`
`+p:p;break;case"event":o.event=p;break;case"id":e(o.id=p);break;case"retry":const m=parseInt(p,10);isNaN(m)||t(o.retry=m);break}}}}function Ot(e,t){const s=new Uint8Array(e.length+t.length);return s.set(e),s.set(t,e.length),s}function be(){return{data:"",event:"",id:"",retry:void 0}}var Et=function(e,t){var s={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(s[o]=e[o]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(s[o[n]]=e[o[n]]);return s};const Z="text/event-stream",qt=1e3,we="last-event-id";function It(e,t){var{signal:s,headers:o,onopen:n,onmessage:a,onclose:r,onerror:l,openWhenHidden:c,fetch:f}=t,p=Et(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((m,g)=>{const _=Object.assign({},o);_.accept||(_.accept=Z);let u;function v(){u.abort(),document.hidden||R()}c||document.addEventListener("visibilitychange",v);let C=qt,y=0;function L(){document.removeEventListener("visibilitychange",v),window.clearTimeout(y),u.abort()}s==null||s.addEventListener("abort",()=>{L(),m()});const j=f??window.fetch,A=n??Lt;async function R(){var F;u=new AbortController;try{const I=await j(e,Object.assign(Object.assign({},p),{headers:_,signal:u.signal}));await A(I),await Mt(I.body,Tt(xt(q=>{q?_[we]=q:delete _[we]},q=>{C=q},a))),r==null||r(),L(),m()}catch(I){if(!u.signal.aborted)try{const q=(F=l==null?void 0:l(I))!==null&&F!==void 0?F:C;window.clearTimeout(y),y=window.setTimeout(R,q)}catch(q){L(),g(q)}}}R()})}function Lt(e){const t=e.headers.get("content-type");if(!(t!=null&&t.startsWith(Z)))throw new Error(`Expected content-type to be ${Z}, Actual: ${t}`)}class At{constructor(t={}){B(this,"onOpen");B(this,"onClose");B(this,"onError");B(this,"onMessage");B(this,"opt",{url:"",data:{}});B(this,"controller",new AbortController);this.opt={...this.opt,...t},this.open()}open(){const t=new FormData;for(const s in this.opt.data)Object.prototype.hasOwnProperty.call(this.opt.data,s)&&t.append(s,this.opt.data[s]);It(this.opt.url,{method:"POST",signal:this.controller.signal,openWhenHidden:!0,body:t,onopen:async s=>{if(s.ok&&s.headers.get("content-type")===Z)typeof this.onOpen=="function"&&this.onOpen();else throw s.status>=400&&s.status<500&&s.status!==429?new Error("连接出错"):new Error("连接出错")},onmessage:s=>{typeof this.onMessage=="function"&&this.onMessage(s)},onclose:()=>{typeof this.onClose=="function"&&this.onClose(),this.controller.abort()},onerror:s=>{typeof this.onError=="function"&&this.onError(s)}})}abort(){this.controller.abort()}}const Pt={avater:le},de=Te("user",()=>ae({...Pt}));function Rt(e){const t=new FormData;return Object.keys(e).forEach(s=>{e[s]!==void 0&&e[s]!==null&&t.append(s,e[s])}),t}function W(e=16,t=0){const s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];let n;if(t=t||s.length,e)for(n=0;n<e;n++)o[n]=s[0|Math.random()*t];else{let a;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",n=0;n<36;n++)o[n]||(a=0|Math.random()*16,o[n]=s[n==19?a&3|8:a])}return o.join("")}function Re(){let e=he.get("openid");return e||(e=W(16),he.set("openid",e)),e}function ke(e){return e.replace(/[&<"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case'"':return"&quot;";default:return"&#039;"}})}const Se=(e,t)=>t,je=e=>{const t={t:a=>Se(e,a)};if(!_e)return t;const{t:s,...o}=_e.global;return{...o,t:(a,...r)=>a?!a.includes(".")&&!e?a:s(Se(e,a),...r):""}};function jt(e){const{t}=je();let s=e.response.status,o=e.response.data.message||e.message,n="";switch(s){case 400:n=`${o}`;break;case 401:n=t("common.errMsg401");break;case 403:n=t("common.errMsg403");break;case 404:n=t("common.errMsg404");break;case 405:n=t("common.errMsg405");break;case 408:n=t("common.errMsg408");break;case 500:n=t("common.errMsg500");break;case 501:n=t("common.errMsg501");break;case 502:n=t("common.errMsg502");break;case 503:n=t("common.errMsg503");break;case 504:n=t("common.errMsg504");break;case 505:n=t("common.errMsg505");break;default:n=`${o}`}return n}let oe=!1;function Fe(e){oe||(oe=!0,Y(e),setTimeout(()=>{oe=!1},200))}const Ft=e=>{if(e.method==="post"&&e.headers["Content-Type"]==="application/x-www-form-urlencoded"?e.data=at.stringify(e.data):e.method==="post"&&e.headers["Content-Type"]==="multipart/form-data"&&(e.data=Rt(e.data)),e.method==="get"&&e.params){let t=e.url;t+="?";const s=Object.keys(e.params);for(const o of s)e.params[o]!==void 0&&e.params[o]!==null&&(t+=`${o}=${encodeURIComponent(e.params[o])}&`);t=t.substring(0,t.length-1),e.params={},e.url=t}return e},$t=e=>{var t,s,o;if(e.data&&typeof e.data.res<"u"&&(e.data.code=e.data.res,e.data.message=e.data.msg||""),((t=e==null?void 0:e.config)==null?void 0:t.responseType)==="blob")return e;if(e.data.code===yt)return e.data;if(Y((s=e==null?void 0:e.data)==null?void 0:s.message),((o=e==null?void 0:e.data)==null?void 0:o.code)===401)de().logout();else return Promise.reject(e.data)},Nt=e=>e.response?(console.log("response err： "+e),Ht(e)):e.request?(console.log("request err： "+e),Bt(e)):Promise.reject(e),Bt=e=>{var c,f,p;const{t}=je(),{response:s,code:o,message:n}=e||{},a=((f=(c=s==null?void 0:s.data)==null?void 0:c.error)==null?void 0:f.message)??"",r=((p=e==null?void 0:e.toString)==null?void 0:p.call(e))??"";let l="";return o==="ECONNABORTED"&&n.indexOf("timeout")!==-1?l=t("common.apiTimeoutMessage"):r!=null&&r.includes("Network Error")?l=t("common.networkExceptionMsg"):l=a,Fe(l),Promise.reject(e)},Ht=e=>{var o;let t=(o=e==null?void 0:e.response)==null?void 0:o.status,s=jt(e);return Fe(s),t===401&&de().logout(),Promise.reject(e)},Dt="",U=new Map,V=nt.create({timeout:wt,baseURL:Dt});V.interceptors.request.use(e=>{const t=new AbortController,s=e.url||"";return e.signal=t.signal,U.set(s,t),e});V.interceptors.response.use(e=>{const t=e.config.url||"";return U.delete(t),e},e=>Promise.reject(e));V.interceptors.request.use(Ft);V.interceptors.response.use($t);V.interceptors.response.use(void 0,Nt);const ce={request:e=>new Promise((t,s)=>{var o;(o=e.interceptors)!=null&&o.requestInterceptors&&(e=e.interceptors.requestInterceptors(e)),V.request(e).then(n=>{t(n)}).catch(n=>{s(n)})}),cancelRequest:e=>{var s;const t=Array.isArray(e)?e:[e];for(const o of t)(s=U.get(o))==null||s.abort(),U.delete(o)},cancelAllRequest(){for(const[e,t]of U)t.abort();U.clear()}},Q=e=>{const t=de(),s=ot(),{url:o,method:n,params:a,data:r,headers:l,responseType:c,withToken:f}=e,p=s.getCurrentLocale,m={"Content-Type":bt,"X-Requested-With":"XMLHttpRequest",lang:p.lang,...l};return f||(m.token=t.getToken??""),ce.request({url:o,method:n,params:a,data:r,responseType:c,headers:{...m}})},ee={get:e=>Q({method:"get",...e}),post:e=>Q({method:"post",...e}),delete:e=>Q({method:"delete",...e}),put:e=>Q({method:"put",...e}),cancelRequest:e=>ce.cancelRequest(e),cancelAllRequest:()=>ce.cancelAllRequest()},Ut="",zt=e=>new At({url:Ut+"/chat/request",data:e}),Vt=e=>ee.post({url:"/chat/welcome",data:e}),Jt=e=>ee.post({url:"/manage/getDialogueList",data:e}),Wt=e=>ee.post({url:"/chat/message",data:e}),Kt=({id:e,prompt:t})=>ee.post({url:"/manage/editPrompt",data:{id:e,prompt:t}}),$e=Te("chat",()=>{const e=Le(),t=M([]);let s=null;const o=M(0),n=M(""),a=ae({admin_user_id:"",avatar:"",id:"",name:"",nickname:"",openid:""}),r=ae({id:null,library_ids:"",prompt:"",robot_avatar:"",robot_intro:"",robot_key:"",robot_name:"",openid:"",welcomes:{content:"",question:[]}}),l=M(!1),c=async i=>{s&&(s.abort(),s=null),t.value=[],I.value=!1,u.value=!1,i.dialogue_id?(l.value=!1,o.value=i.dialogue_id):(l.value=!0,o.value=0),n.value=i.openid||Re(),r.robot_key=i.robot_key,r.openid=n.value,a.openid=n.value,a.avatar=i.avatar||le,a.name=i.name||"",a.nickname=i.nickname||"";const h=await Vt({robot_key:r.robot_key,openid:n.value,nickname:a.nickname,name:a.name,avatar:a.avatar||le});try{const w=h.data.customer,d=h.data.robot;return a.admin_user_id=w.admin_user_id,a.avatar=w.avatar,a.id=w.id,a.name=w.name,a.nickname=w.nickname,r.library_ids=d.library_ids,r.prompt=d.prompt,r.robot_avatar=d.robot_avatar,r.robot_intro=d.robot_intro,r.robot_key=d.robot_key,r.robot_name=d.robot_name,r.library_ids=d.library_ids,r.id=d.id,d.welcomes&&(r.welcomes=JSON.parse(d.welcomes)),f(h.data.message),h}catch(w){Promise.reject(w)}},f=i=>{i&&(i.uid=W(32),i.loading=!1,i.isWelcome=!0,i.avatar=r.robot_avatar,i.menu_json&&(i.menu_json=JSON.parse(i.menu_json)),i.quote_file&&(i.quote_file=JSON.parse(i.quote_file)),t.value.push(i))},p=i=>{i.uid=W(32),i.loading=!1,i.avatar=a.avatar,i.openid=a.openid,i.msg_type=1,i.is_customer=1,t.value.push(i)},m=i=>{t.value.push(i),e.emit("updateAiMessage",i)},g=(i,h,w)=>{const d=t.value.findIndex(k=>k.uid==w);if(i=="sending"){const k=t.value[d].content;t.value[d].content=k+h}i=="quote_file"&&(t.value[d].quote_file=h.length>0?h:[]),i=="ai_message"&&(t.value[d].id=h.id),i=="debug"&&(t.value[d].debug=h.length>0?h:[]),e.emit("updateAiMessage",t.value[d])},_=()=>{const i=t.value.length-1;t.value[i].loading=!1},u=M(!1),v=i=>{if(u.value)return;const h={loading:!0,id:"",content:"",uid:W(32),avatar:r.robot_avatar,msg_type:1,quote_file:[],is_customer:0,debug:[]},w={robot_key:r.robot_key,openid:r.openid,question:i.message,prompt:r.prompt,library_ids:r.library_ids,dialogue_id:o.value};u.value=!0,s=zt(w),s.onMessage=d=>{if(d.event=="dialogue_id"&&(o.value=d.data),d.event=="c_message"){const k=JSON.parse(d.data);p(k)}if(d.event=="robot"&&(m(h),l.value&&(l.value=!1)),d.event=="sending"&&g("sending",d.data,h.uid),d.event=="ai_message"){const k=JSON.parse(d.data);g("ai_message",k,h.uid)}if(d.event=="quote_file"){const k=JSON.parse(d.data);g("quote_file",k,h.uid)}if(d.event=="debug"){const k=JSON.parse(d.data);g("debug",k,h.uid)}},s.onClose=()=>{_(),u.value=!1,s=null}},C=25,y=M([]),L=M(!1),j=M(!1),A=async()=>{if(j.value||L.value)return!1;let i=0;y.value.length>0&&(i=y.value[y.value.length-1].id),L.value=!0;const h=await Jt({min_id:i,size:C,robot_key:r.robot_key});L.value=!1;const w=h.data||[];return w.length===0?(j.value=!0,!1):(y.value=[...y.value,...w],h)},R=async i=>await c(i),F=20,I=M(!1),q=async()=>{if(I.value)return;let i=0;const h=t.value.filter(d=>!d.isWelcome);h.length>0&&(i=h[0].id);const w={robot_key:r.robot_key,openid:a.openid,min_id:i,size:F,dialogue_id:o.value};try{const d=await Wt(w),k=d.data.list||[];if(k.length===0){I.value=!0;return}return k.sort((x,Ne)=>x.id-Ne.id),k.forEach(x=>{x.loading=!1,x.uid=W(32),x.is_customer==1?x.avatar=a.avatar:x.avatar=r.robot_avatar,x.menu_json&&(x.menu_json=JSON.parse(x.menu_json)),x.quote_file&&(x.quote_file=JSON.parse(x.quote_file))}),t.value=[...k,...t.value],d}catch(d){Promise.reject(d)}},b=i=>{r.prompt=i},$=()=>Kt({id:r.id,prompt:r.prompt});function N(){o.value=0,t.value=[],n.value="",a.admin_user_id="",a.avatar="",a.id="",a.name="",a.nickname="",a.openid="",r.id=null,r.library_ids="",r.prompt="",r.robot_avatar="",r.robot_intro="",r.robot_key="",r.robot_key="",r.robot_name="",r.openid="",r.welcomes={content:"",question:[]},l.value=!1,I.value=!1,u.value=!1,L.value=!1,j.value=!1,y.value=[]}return{$reset:N,user:a,robot:r,dialogue_id:o,openid:n,sendLock:u,messageList:t,createChat:c,sendMessage:v,getMyChatList:A,myChatList:y,openChat:R,onGetChatMessage:q,changeRobotPrompt:b,saveRobotPrompt:$}}),Gt={class:"chat-header"},Qt={class:"chat-header-body"},Xt=["src"],Yt={class:"robot-info"},Zt={class:"robot-name"},es={class:"robot-intro"},ts=H({__name:"chat-header",setup(e){const t=$e(),{robot:s}=xe(t),o=()=>{Ct()};return(n,a)=>{const r=Oe("svg-icon");return T(),E("div",Gt,[O(r,{class:"close-btn",name:"close",onClick:o}),S("div",Qt,[P(s).robot_avatar?(T(),E("img",{key:0,class:"avatar",src:P(s).robot_avatar,alt:""},null,8,Xt)):re("",!0),S("div",Yt,[S("div",Zt,K(P(s).robot_name),1),S("div",es,K(P(s).robot_intro),1)])])])}}}),ss=z(ts,[["__scopeId","data-v-fcea83b5"]]),os=["value","onKeydown"],ne=22,ns=3,as=H({__name:"auto-size-textarea",props:{value:{type:String,default:""}},emits:["update:value","change","focus","blur","enter","shiftEnter"],setup(e,{emit:t}){const s=e,o=t,n=ne*ns,a=M(null);function r(){o("focus")}function l(){o("blur")}function c(u){u.shiftKey||o("enter")}function f(u){var v=u.value,C=u.selectionStart;return C===v.length}function p(){if(a.value){const u=a.value.selectionStart,v=a.value.value.slice(0,u)+`
`+a.value.value.slice(u);a.value.value=v,f(a.value)&&(a.value.scrollTop=a.value.scrollHeight),a.value.setSelectionRange(u+1,u+1),_()}}function m(u){u.preventDefault(),p(),o("shiftEnter")}function g(u){const v=u.target;o("update:value",v.value),o("change",v.value),_()}function _(){a.value&&(a.value.style.height="auto",a.value.scrollHeight>n?a.value.style.height=`${n}px`:a.value.value.length==0?a.value.style.height=`${ne}px`:a.value.style.height=`${a.value.scrollHeight}px`)}return X(()=>s.value,()=>{!s.value&&a.value&&(a.value.style.height=`${ne}px`)}),ue(()=>{a.value&&_()}),(u,v)=>(T(),E("textarea",{class:"auto-size-textarea",rows:"1",ref_key:"textareaRef",ref:a,value:s.value,onInput:g,onFocus:r,onBlur:l,onKeydown:[fe(me(c,["prevent","exact"]),["enter"]),fe(me(m,["shift","prevent"]),["enter"])],placeholder:"在此输入，Shift+Enter换行"},null,40,os))}}),rs=z(as,[["__scopeId","data-v-a17959af"]]),is={class:"message-input-box"},ls={class:"message-input-body"},cs=H({__name:"message-input",props:{value:{type:String,default:""}},emits:["update:value","send"],setup(e,{emit:t}){const s=t,o=e,n=M(!1),a=l=>{s("update:value",l)},r=()=>{o.value.trim()&&s("send",o.value)};return(l,c)=>{const f=Oe("svg-icon");return T(),E("div",is,[S("div",ls,[S("div",{class:Ee(["message-input",{"is-focus":n.value}])},[O(rs,{value:e.value,class:"text-input",onChange:a,onFocus:c[0]||(c[0]=p=>n.value=!0),onBlur:c[1]||(c[1]=p=>n.value=!1),onEnter:r},null,8,["value"]),O(f,{name:"paper-airplane",class:"send-btn",onClick:r})],2)])])}}}),us=z(cs,[["__scopeId","data-v-a356030c"]]),ds=H({__name:"message-list",props:{messages:{type:Array,default:()=>[]}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd"],setup(e,{expose:t,emit:s}){const o=s,n=e,a=M(null),r={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60};let l=null,c=!1;function f(){n.messages.length!=0&&o("scrollStart",{msg:n.messages[0]})}function p(){n.messages.length!=0&&o("scrollEnd",{msg:n.messages[n.messages.length-1]})}function m(u){c||(l!==null&&(clearTimeout(l),l=null),l=window.setTimeout(()=>{r.scrollTop=u.target.scrollTop,r.scrollHeight=u.target.scrollHeight,r.clientHeight=u.target.clientHeight,o("scroll",{...r}),Math.abs(r.scrollTop)<=r.scrollStartDiff&&f(),Math.abs(r.scrollHeight-r.scrollTop-r.clientHeight)<=r.scrollEndDiff&&p()},50))}const g=()=>{a.value&&pe(()=>{c=!0,a.value&&(a.value.scrollTop=a.value.scrollHeight+1,setTimeout(()=>{c=!1},50))})};function _(u,v){pe(()=>{c=!0,v||(v="top");let C=a.value,y=document.querySelector("#msg-"+u);!C||!y||(v=="top"?C.scrollTop=y.offsetTop:C.scrollTop=y.offsetTop-C.clientHeight+y.clientHeight,setTimeout(()=>{c=!1},50))})}return t({scrollToBottom:g,scrollToMessage:_}),(u,v)=>(T(),E("div",{class:"message-list",ref_key:"scrollBoxRef",ref:a,onScroll:m},[Ue(u.$slots,"default",{},void 0)],544))}}),fs=z(ds,[["__scopeId","data-v-7e037515"]]),ms=["id"],ps={class:"message-item-left"},gs=["src"],vs={class:"message-item-body"},hs={class:"message-content"},_s={key:0,class:"text-message"},ys={class:"text-message"},bs={key:0,class:"question-list"},ws=["onClick"],ks=H({__name:"message-item",props:{msg:{type:Object,required:!0}},emits:["sendTextMessage"],setup(e,{emit:t}){const s=t,o=e,n=ge(()=>o.msg.is_customer==1),a=ge(()=>({"user-message-item":n.value===!0,"robot-message-item":n.value===!1,"welcome-message-item":o.msg.menu_json&&o.msg.menu_json.question})),r=l=>{s("sendTextMessage",l)};return(l,c)=>(T(),E("div",{class:Ee(["message-item",a.value]),id:"msg-"+e.msg.uid},[S("div",ps,[S("img",{class:"avatar",src:o.msg.avatar},null,8,gs)]),S("div",vs,[S("div",hs,[o.msg.msg_type==1?(T(),E("div",_s,K(P(ke)(o.msg.content)),1)):o.msg.msg_type==2?(T(),E(ie,{key:1},[S("div",ys,K(P(ke)(o.msg.menu_json.content)),1),o.msg.menu_json&&o.msg.menu_json.question.length?(T(),E("div",bs,[(T(!0),E(ie,null,qe(o.msg.menu_json.question,f=>(T(),E("div",{class:"question-item",key:f,onClick:p=>r(f)},[S("span",null,K(f),1)],8,ws))),128))])):re("",!0)],64)):re("",!0)])])],10,ms))}}),Ss=z(ks,[["__scopeId","data-v-db39b40c"]]),Cs={class:"chat-page"},Ms={class:"chat-page-header"},Ts={class:"chat-page-body"},xs={class:"messages-list-wrap"},Os={class:"chat-page-footer"},Es=H({__name:"index",setup(e){const t=Ve(),s=Le(),o=$e(),{sendMessage:n,openChat:a,onGetChatMessage:r,$reset:l}=o,{messageList:c,sendLock:f,dialogue_id:p,robot:m}=xe(o);let g=!0;const _=M(null),u=b=>{_.value&&_.value.scrollToMessage(b)},v=()=>{_.value&&g&&_.value.scrollToBottom()},C=async()=>{g=!1;let b=c.value[0].uid;await r()&&u(b)},y=()=>{},L=b=>{b.sdkFloatAvatar=kt,St(b)},j=async()=>{g=!0;let b=t.query||{},$={robot_key:b.robot_key,avatar:b.avatar||"",name:b.name||"",nickname:b.nickname||"",openid:Re(),dialogue_id:p.value};await a($),await r()&&v(),L(Je(m.value))},A=M(""),R=b=>{if(!b)return Y("请输入消息内容");n({message:b})},F=async()=>{if(!A.value)return Y("请输入消息内容");g=!0,R(A.value),A.value=""},I=()=>{v()},q=()=>{v()};return ue(()=>{j(),s.on("updateAiMessage",I),s.on("openWindow",q)}),Ce(()=>{l()}),(b,$)=>(T(),E("div",Cs,[S("div",Ms,[O(ss)]),S("div",Ts,[S("div",xs,[O(fs,{ref_key:"messageListRef",ref:_,messages:P(c),onScrollStart:C,onScrollEnd:y},{default:ze(()=>[(T(!0),E(ie,null,qe(P(c),N=>(T(),We(Ss,{key:N.uid,msg:N,onSendTextMessage:R},null,8,["msg"]))),128))]),_:1},8,["messages"])])]),S("div",Os,[O(us,{value:A.value,"onUpdate:value":$[0]||($[0]=N=>A.value=N),onSend:F,loading:P(f)},null,8,["value","loading"])])]))}}),$s=z(Es,[["__scopeId","data-v-1f45216b"]]);export{$s as default};
