import{u as K,_ as w,e as D,a as Q,s as R,D as X}from"./index.js";import{e as M,J as N,f as B,B as O,C as m,H as p,h as x,I as u,u as y,K as A,L as b,M as Y,r as k,w as Z,b as V,N as F,O as j,P as z,Q as ee,n as q,F as E,S as U,o as se,D as te,U as oe,V as ae,W as ne,A as le}from"./vue-chunks-BpMrDWVc.js";import"./axios-B4uVmeYG.js";import"./qs-DrHefV6n.js";import"./dayjs-C4iS2aBk.js";import"./crypto-js-BJ7SvduI.js";function J(c,i){if(i)try{i=JSON.parse(JSON.stringify(i))}catch(a){console.error("Failed to stringify data:",a);return}if(window.parent&&typeof window.parent.postMessage=="function")try{window.parent.postMessage({action:c,data:i},"*")}catch(a){console.error("Failed to post message:",a)}else console.warn("window.parent is not available or postMessage is not supported.")}function ce(c){J("init",c)}function ie(){J("closeChat")}const re={class:"chat-header-body"},ue=["src"],de={class:"robot-info"},ge={class:"robot-name"},me={class:"robot-intro"},pe=M({__name:"chat-header",setup(c){const i=K(),{externalConfigPC:a}=N(i),{headBackgroundColor:s}=a.value.pageStyle,n=B(()=>{const[t,r,l,d]=s.split(",");return t==="color"?l:`${t}(${r}, ${l}, ${d})`}),e=()=>{ie()};return(t,r)=>{const l=O("svg-icon");return m(),p("div",{class:"chat-header",style:Y({background:n.value})},[x(l,{class:"close-btn",name:"close",onClick:e}),u("div",re,[y(a).headImage?(m(),p("img",{key:0,class:"avatar",src:y(a).headImage,alt:""},null,8,ue)):A("",!0),u("div",de,[u("div",ge,b(y(a).headTitle),1),u("div",me,b(y(a).headSubTitle),1)])])],4)}}}),ve=w(pe,[["__scopeId","data-v-1372811b"]]),fe=["value","onKeydown"],I=22,_e=3,he=M({__name:"auto-size-textarea",props:{value:{type:String,default:""}},emits:["update:value","change","focus","blur","enter","shiftEnter"],setup(c,{emit:i}){const a=c,s=i,n=I*_e,e=k(null);function t(){s("focus")}function r(){s("blur")}function l(o){o.shiftKey||s("enter")}function d(o){var g=o.value,h=o.selectionStart;return h===g.length}function v(){if(e.value){const o=e.value.selectionStart,g=e.value.value.slice(0,o)+`
`+e.value.value.slice(o);e.value.value=g,d(e.value)&&(e.value.scrollTop=e.value.scrollHeight),e.value.setSelectionRange(o+1,o+1),T()}}function $(o){o.preventDefault(),v(),s("shiftEnter")}function S(o){const g=o.target;s("update:value",g.value),s("change",g.value),T()}function T(){e.value&&(e.value.style.height="auto",e.value.scrollHeight>n?e.value.style.height=`${n}px`:e.value.value.length==0?e.value.style.height=`${I}px`:e.value.style.height=`${e.value.scrollHeight}px`)}return Z(()=>a.value,()=>{!a.value&&e.value&&(e.value.style.height=`${I}px`)}),V(()=>{e.value&&T()}),(o,g)=>(m(),p("textarea",{class:"auto-size-textarea",rows:"1",ref_key:"textareaRef",ref:e,value:a.value,onInput:S,onFocus:t,onBlur:r,onKeydown:[F(j(l,["prevent","exact"]),["enter"]),F(j($,["shift","prevent"]),["enter"])],placeholder:"在此输入，Shift+Enter换行"},null,40,fe))}}),ye=w(he,[["__scopeId","data-v-a17959af"]]),Se={class:"message-input-box"},Te={class:"message-input-body"},xe=M({__name:"message-input",props:{value:{type:String,default:""}},emits:["update:value","send"],setup(c,{emit:i}){const a=i,s=c,n=k(!1),e=r=>{a("update:value",r)},t=()=>{s.value.trim()&&a("send",s.value)};return(r,l)=>{const d=O("svg-icon");return m(),p("div",Se,[u("div",Te,[u("div",{class:z(["message-input",{"is-focus":n.value}])},[x(ye,{value:c.value,class:"text-input",onChange:e,onFocus:l[0]||(l[0]=v=>n.value=!0),onBlur:l[1]||(l[1]=v=>n.value=!1),onEnter:t},null,8,["value"]),x(d,{name:"paper-airplane",class:"send-btn",onClick:t})],2)])])}}}),we=w(xe,[["__scopeId","data-v-866348a9"]]),Me=M({__name:"message-list",props:{messages:{type:Array,default:()=>[]}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd"],setup(c,{expose:i,emit:a}){const s=a,n=c,e=k(null),t={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60};let r=null,l=!1;function d(){n.messages.length!=0&&s("scrollStart",{msg:n.messages[0]})}function v(){n.messages.length!=0&&s("scrollEnd",{msg:n.messages[n.messages.length-1]})}function $(o){l||(r!==null&&(clearTimeout(r),r=null),r=window.setTimeout(()=>{t.scrollTop=o.target.scrollTop,t.scrollHeight=o.target.scrollHeight,t.clientHeight=o.target.clientHeight,s("scroll",{...t}),Math.abs(t.scrollTop)<=t.scrollStartDiff&&d(),Math.abs(t.scrollHeight-t.scrollTop-t.clientHeight)<=t.scrollEndDiff&&v()},50))}const S=()=>{e.value&&q(()=>{l=!0,e.value&&(e.value.scrollTop=e.value.scrollHeight+1,setTimeout(()=>{l=!1},50))})};function T(o,g){q(()=>{l=!0,g||(g="top");let h=e.value,_=document.querySelector("#msg-"+o);!h||!_||(g=="top"?h.scrollTop=_.offsetTop:h.scrollTop=_.offsetTop-h.clientHeight+_.clientHeight,setTimeout(()=>{l=!1},50))})}return i({scrollToBottom:S,scrollToMessage:T}),(o,g)=>(m(),p("div",{class:"message-list",ref_key:"scrollBoxRef",ref:e,onScroll:$},[ee(o.$slots,"default",{},void 0)],544))}}),$e=w(Me,[["__scopeId","data-v-7e037515"]]),be=["id"],ke={class:"message-item-left"},Ce=["src"],He={class:"message-item-body"},Ie={class:"message-content"},Be={key:0,class:"text-message"},Ae={class:"text-message"},Ee={key:0,class:"question-list"},Le=["onClick"],De=M({__name:"message-item",props:{msg:{type:Object,required:!0}},emits:["sendTextMessage"],setup(c,{emit:i}){const a=i,s=c,n=B(()=>s.msg.is_customer==1),e=B(()=>({"user-message-item":n.value===!0,"robot-message-item":n.value===!1,"welcome-message-item":s.msg.menu_json&&s.msg.menu_json.question})),t=r=>{a("sendTextMessage",r)};return(r,l)=>(m(),p("div",{class:z(["message-item",e.value]),id:"msg-"+c.msg.uid},[u("div",ke,[u("img",{class:"avatar",src:s.msg.avatar},null,8,Ce)]),u("div",He,[u("div",Ie,[s.msg.msg_type==1?(m(),p("div",Be,b(y(D)(s.msg.content)),1)):s.msg.msg_type==2?(m(),p(E,{key:1},[u("div",Ae,b(y(D)(s.msg.menu_json.content)),1),s.msg.menu_json&&s.msg.menu_json.question.length?(m(),p("div",Ee,[(m(!0),p(E,null,U(s.msg.menu_json.question,d=>(m(),p("div",{class:"question-item",key:d,onClick:v=>t(d)},[u("span",null,b(d),1)],8,Le))),128))])):A("",!0)],64)):A("",!0)])])],10,be))}}),Re=w(De,[["__scopeId","data-v-db39b40c"]]),Fe=c=>(ae("data-v-57cdb2de"),c=c(),ne(),c),je={class:"chat-page"},qe={class:"chat-page-header"},Ke={class:"chat-page-body"},Ne={class:"messages-list-wrap"},Oe={class:"chat-page-footer"},Ve=Fe(()=>u("div",{class:"technical-support-text"},"由chatwiki提供软件支持",-1)),ze=M({__name:"index",setup(c){const i=Q(),a=K(),{sendMessage:s,onGetChatMessage:n,$reset:e}=a,{messageList:t,sendLock:r,robot:l}=N(a);let d=!0;const v=k(null),$=f=>{v.value&&v.value.scrollToMessage(f)},S=()=>{v.value&&d&&v.value.scrollToBottom()},T=async()=>{d=!1;let f=t.value[0].uid;await n()&&$(f)},o=()=>{},g=f=>{f.sdkFloatAvatar=X,ce(f)},h=async()=>{d=!0,await n()&&S(),g(oe(l.value))},_=k(""),L=f=>{if(!f)return R("请输入消息内容");s({message:f})},P=async()=>{if(!_.value)return R("请输入消息内容");d=!0,L(_.value),_.value=""},W=()=>{S()},G=()=>{S()};return V(()=>{h(),i.on("updateAiMessage",W),i.on("openWindow",G)}),se(()=>{e()}),(f,H)=>(m(),p("div",je,[u("div",qe,[x(ve)]),u("div",Ke,[u("div",Ne,[x($e,{ref_key:"messageListRef",ref:v,messages:y(t),onScrollStart:T,onScrollEnd:o},{default:te(()=>[(m(!0),p(E,null,U(y(t),C=>(m(),le(Re,{key:C.uid,msg:C,onSendTextMessage:L},null,8,["msg"]))),128))]),_:1},8,["messages"])])]),u("div",Oe,[x(we,{value:_.value,"onUpdate:value":H[0]||(H[0]=C=>_.value=C),onSend:P,loading:y(r)},null,8,["value","loading"]),Ve])]))}}),Xe=w(ze,[["__scopeId","data-v-57cdb2de"]]);export{Xe as default};
