var at=Object.defineProperty;var rt=(e,t,o)=>t in e?at(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var N=(e,t,o)=>(rt(e,typeof t!="symbol"?t+"":t,o),o);import{g as _e,r as _,a as $e,j as lt,w as H,e as F,h as C,T as Be,F as je,G as Fe,f as ve,n as me,b as ce,c as it,p as ct,H as ut,I as se,m as ne,o as De,E as dt,d as ae,s as Ne,J as ze,x as He,y as E,C as A,D as I,u as j,K as pe,L as ee,M as Ce,N as Se,O as Ue,P as ft,Q as Ve,z as vt,S as mt,U as pt,v as gt}from"./vue-chunks-Bh70r4GF.js";import{i as ht,n as _t,e as J,a as z,t as V,u as re,T as Oe,o as yt,b as bt,p as Ke,c as ye,d as We,f as wt,h as be,w as we,m as W,j as kt,H as Ct,I as Je,k as St,l as Ot,L as Tt,q as xt,r as Mt,S as Te,s as xe,v as It,x as Ge,_ as G}from"../../index.js";import{a as Et}from"./axios-B4uVmeYG.js";import{q as Lt}from"./qs-DrHefV6n.js";import"./dayjs-C4iS2aBk.js";import"./crypto-js-BJ7SvduI.js";function At(e,{args:t=[],done:o,canceled:s,error:n}){if(e){const a=e.apply(null,t);ht(a)?a.then(r=>{r?o():s&&s()}).catch(n||_t):a?o():s&&s()}else o()}const Pt=Symbol();function Ye(e){const t=_e();t&&J(t.proxy,e)}const qt={show:Boolean,zIndex:z,overlay:V,duration:z,teleport:[String,Object],lockScroll:V,lazyRender:V,beforeClose:Function,overlayStyle:Object,overlayClass:re,transitionAppear:Boolean,closeOnClickOverlay:V};function Rt(e,t){return e>t?"horizontal":t>e?"vertical":""}function $t(){const e=_(0),t=_(0),o=_(0),s=_(0),n=_(0),a=_(0),r=_(""),l=_(!0),c=()=>r.value==="vertical",d=()=>r.value==="horizontal",v=()=>{o.value=0,s.value=0,n.value=0,a.value=0,r.value="",l.value=!0};return{move:p=>{const u=p.touches[0];o.value=(u.clientX<0?0:u.clientX)-e.value,s.value=u.clientY-t.value,n.value=Math.abs(o.value),a.value=Math.abs(s.value);const g=10;(!r.value||n.value<g&&a.value<g)&&(r.value=Rt(n.value,a.value)),l.value&&(n.value>Oe||a.value>Oe)&&(l.value=!1)},start:p=>{v(),e.value=p.touches[0].clientX,t.value=p.touches[0].clientY},reset:v,startX:e,startY:t,deltaX:o,deltaY:s,offsetX:n,offsetY:a,direction:r,isVertical:c,isHorizontal:d,isTap:l}}let X=0;const Me="van-overflow-hidden";function Bt(e,t){const o=$t(),s="01",n="10",a=v=>{o.move(v);const m=o.deltaY.value>0?n:s,h=bt(v.target,e.value),{scrollHeight:p,offsetHeight:u,scrollTop:g}=h;let b="11";g===0?b=u>=p?"00":"01":g+u>=p&&(b="10"),b!=="11"&&o.isVertical()&&!(parseInt(b,2)&parseInt(m,2))&&Ke(v,!0)},r=()=>{document.addEventListener("touchstart",o.start),document.addEventListener("touchmove",a,{passive:!1}),X||document.body.classList.add(Me),X++},l=()=>{X&&(document.removeEventListener("touchstart",o.start),document.removeEventListener("touchmove",a),X--,X||document.body.classList.remove(Me))},c=()=>t()&&r(),d=()=>t()&&l();yt(c),$e(d),lt(d),H(t,v=>{v?r():l()})}function Xe(e){const t=_(!1);return H(e,o=>{o&&(t.value=o)},{immediate:!0}),o=>()=>t.value?o():null}const Ie=()=>{var e;const{scopeId:t}=((e=_e())==null?void 0:e.vnode)||{};return t?{[t]:""}:null},[jt,Ft]=ye("overlay"),Dt={show:Boolean,zIndex:z,duration:z,className:re,lockScroll:V,lazyRender:V,customStyle:Object};var Nt=F({name:jt,props:Dt,setup(e,{slots:t}){const o=_(),s=Xe(()=>e.show||!e.lazyRender),n=r=>{e.lockScroll&&Ke(r,!0)},a=s(()=>{var r;const l=J(wt(e.zIndex),e.customStyle);return be(e.duration)&&(l.animationDuration=`${e.duration}s`),je(C("div",{ref:o,style:l,class:[Ft(),e.className]},[(r=t.default)==null?void 0:r.call(t)]),[[Fe,e.show]])});return We("touchmove",n,{target:o}),()=>C(Be,{name:"van-fade",appear:!0},{default:a})}});const zt=we(Nt),Ht=J({},qt,{round:Boolean,position:W("center"),closeIcon:W("cross"),closeable:Boolean,transition:String,iconPrefix:String,closeOnPopstate:Boolean,closeIconPosition:W("top-right"),safeAreaInsetTop:Boolean,safeAreaInsetBottom:Boolean}),[Ut,Ee]=ye("popup");var Vt=F({name:Ut,inheritAttrs:!1,props:Ht,emits:["open","close","opened","closed","keydown","update:show","clickOverlay","clickCloseIcon"],setup(e,{emit:t,attrs:o,slots:s}){let n,a;const r=_(),l=_(),c=Xe(()=>e.show||!e.lazyRender),d=ve(()=>{const y={zIndex:r.value};if(be(e.duration)){const O=e.position==="center"?"animationDuration":"transitionDuration";y[O]=`${e.duration}s`}return y}),v=()=>{n||(n=!0,r.value=e.zIndex!==void 0?+e.zIndex:kt(),t("open"))},m=()=>{n&&At(e.beforeClose,{done(){n=!1,t("close"),t("update:show",!1)}})},h=y=>{t("clickOverlay",y),e.closeOnClickOverlay&&m()},p=()=>{if(e.overlay)return C(zt,ne({show:e.show,class:e.overlayClass,zIndex:r.value,duration:e.duration,customStyle:e.overlayStyle,role:e.closeOnClickOverlay?"button":void 0,tabindex:e.closeOnClickOverlay?0:void 0},Ie(),{onClick:h}),{default:s["overlay-content"]})},u=y=>{t("clickCloseIcon",y),m()},g=()=>{if(e.closeable)return C(Je,{role:"button",tabindex:0,name:e.closeIcon,class:[Ee("close-icon",e.closeIconPosition),Ct],classPrefix:e.iconPrefix,onClick:u},null)};let b;const S=()=>{b&&clearTimeout(b),b=setTimeout(()=>{t("opened")})},P=()=>t("closed"),$=y=>t("keydown",y),q=c(()=>{var y;const{round:O,position:T,safeAreaInsetTop:k,safeAreaInsetBottom:B}=e;return je(C("div",ne({ref:l,style:d.value,role:"dialog",tabindex:0,class:[Ee({round:O,[T]:T}),{"van-safe-area-top":k,"van-safe-area-bottom":B}],onKeydown:$},o,Ie()),[(y=s.default)==null?void 0:y.call(s),g()]),[[Fe,e.show]])}),R=()=>{const{position:y,transition:O,transitionAppear:T}=e,k=y==="center"?"van-fade":`van-popup-slide-${y}`;return C(Be,{name:O||k,appear:T,onAfterEnter:S,onAfterLeave:P},{default:q})};return H(()=>e.show,y=>{y&&!n&&(v(),o.tabindex===0&&me(()=>{var O;(O=l.value)==null||O.focus()})),!y&&n&&(n=!1,t("close"))}),Ye({popupRef:l}),Bt(l,()=>e.show&&e.lockScroll),We("popstate",()=>{e.closeOnPopstate&&(m(),a=!1)}),ce(()=>{e.show&&v()}),it(()=>{a&&(t("update:show",!0),a=!1)}),$e(()=>{e.show&&e.teleport&&(m(),a=!0)}),ct(Pt,()=>e.show),()=>e.teleport?C(ut,{to:e.teleport},{default:()=>[p(),R()]}):C(se,null,[p(),R()])}});const Kt=we(Vt);let Q=0;function Wt(e){e?(Q||document.body.classList.add("van-toast--unclickable"),Q++):Q&&(Q--,Q||document.body.classList.remove("van-toast--unclickable"))}const[Jt,U]=ye("toast"),Gt=["show","overlay","teleport","transition","overlayClass","overlayStyle","closeOnClickOverlay","zIndex"],Yt={icon:String,show:Boolean,type:W("text"),overlay:Boolean,message:z,iconSize:z,duration:Ot(2e3),position:W("middle"),teleport:[String,Object],wordBreak:String,className:re,iconPrefix:String,transition:W("van-fade"),loadingType:String,forbidClick:Boolean,overlayClass:re,overlayStyle:Object,closeOnClick:Boolean,closeOnClickOverlay:Boolean,zIndex:z};var Qe=F({name:Jt,props:Yt,emits:["update:show"],setup(e,{emit:t,slots:o}){let s,n=!1;const a=()=>{const m=e.show&&e.forbidClick;n!==m&&(n=m,Wt(n))},r=m=>t("update:show",m),l=()=>{e.closeOnClick&&r(!1)},c=()=>clearTimeout(s),d=()=>{const{icon:m,type:h,iconSize:p,iconPrefix:u,loadingType:g}=e;if(m||h==="success"||h==="fail")return C(Je,{name:m||h,size:p,class:U("icon"),classPrefix:u},null);if(h==="loading")return C(Tt,{class:U("loading"),size:p,type:g},null)},v=()=>{const{type:m,message:h}=e;if(o.message)return C("div",{class:U("text")},[o.message()]);if(be(h)&&h!=="")return m==="html"?C("div",{key:0,class:U("text"),innerHTML:String(h)},null):C("div",{class:U("text")},[h])};return H(()=>[e.show,e.forbidClick],a),H(()=>[e.show,e.type,e.message,e.duration],()=>{c(),e.show&&e.duration>0&&(s=setTimeout(()=>{r(!1)},e.duration))}),ce(a),De(a),()=>C(Kt,ne({class:[U([e.position,e.wordBreak==="normal"?"break-normal":e.wordBreak,{[e.type]:!e.icon}]),e.className],lockScroll:!1,onClick:l,onClosed:c,"onUpdate:show":r},St(e,Gt)),{default:()=>[d(),v()]})}});function Xt(){const e=ae({show:!1}),t=n=>{e.show=n},o=n=>{J(e,n,{transitionAppear:!0}),t(!0)},s=()=>t(!1);return Ye({open:o,close:s,toggle:t}),{open:o,close:s,state:e,toggle:t}}function Qt(e){const t=dt(e),o=document.createElement("div");return document.body.appendChild(o),{instance:t.mount(o),unmount(){t.unmount(),document.body.removeChild(o)}}}const Zt={icon:"",type:"text",message:"",className:"",overlay:!1,onClose:void 0,onOpened:void 0,duration:2e3,teleport:"body",iconSize:void 0,iconPrefix:void 0,position:"middle",transition:"van-fade",forbidClick:!1,loadingType:void 0,overlayClass:"",overlayStyle:void 0,closeOnClick:!1,closeOnClickOverlay:!1};let te=[],eo=!1,Le=J({},Zt);const to=new Map;function oo(e){return Mt(e)?e:{message:e}}function so(){const{instance:e,unmount:t}=Qt({setup(){const o=_(""),{open:s,state:n,close:a,toggle:r}=Xt(),l=()=>{},c=()=>C(Qe,ne(n,{onClosed:l,"onUpdate:show":r}),null);return H(o,d=>{n.message=d}),_e().render=c,{open:s,close:a,message:o}}});return e}function no(){if(!te.length||eo){const e=so();te.push(e)}return te[te.length-1]}function le(e={}){if(!xt)return{};const t=no(),o=oo(e);return t.open(J({},Le,to.get(o.type||Le.type),o)),t}we(Qe);const ao=0,ro="application/x-www-form-urlencoded;charset=UTF-8",lo=5*60*1e3,ge=new URL("/assets/img/user_avatar_2x-D7HF6Y-m.png",import.meta.url).href,io=new URL("data:image/svg+xml,%3csvg%20width='62'%20height='62'%20viewBox='0%200%2062%2062'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3ccircle%20cx='31'%20cy='31'%20r='31'%20fill='url(%23paint0_linear_930_6995)'/%3e%3cpath%20d='M39%2036.3346C41.9455%2036.3346%2044.3333%2033.9468%2044.3333%2031.0013C44.3333%2028.0558%2041.9455%2025.668%2039%2025.668'%20stroke='%23F2F4FF'%20stroke-width='2.66667'%20stroke-linejoin='round'/%3e%3cpath%20d='M23.0013%2025.668C20.0558%2025.668%2017.668%2028.0558%2017.668%2031.0013C17.668%2033.9468%2020.0558%2036.3346%2023.0013%2036.3346'%20stroke='%23F2F4FF'%20stroke-width='2.66667'%20stroke-linejoin='round'/%3e%3cpath%20d='M23%2036.3346V36.0013V34.3346V31.0013V25.668C23%2021.2497%2026.5817%2017.668%2031%2017.668C35.4183%2017.668%2039%2021.2497%2039%2025.668V36.3346C39%2040.7529%2035.4183%2044.3346%2031%2044.3346'%20stroke='%23F2F4FF'%20stroke-width='2.66667'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3cdefs%3e%3clinearGradient%20id='paint0_linear_930_6995'%20x1='31'%20y1='0'%20x2='31'%20y2='62'%20gradientUnits='userSpaceOnUse'%3e%3cstop%20stop-color='%23336DFF'/%3e%3cstop%20offset='1'%20stop-color='%23495EFF'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",import.meta.url).href;function Ze(e,t){if(t)try{t=JSON.parse(JSON.stringify(t))}catch(o){console.error("Failed to stringify data:",o);return}if(window.parent&&typeof window.parent.postMessage=="function")try{window.parent.postMessage({action:e,data:t},"*")}catch(o){console.error("Failed to post message:",o)}else console.warn("window.parent is not available or postMessage is not supported.")}function co(e){Ze("init",e)}function uo(){Ze("closeChat")}async function fo(e,t){const o=e.getReader();let s;for(;!(s=await o.read()).done;)t(s.value)}function vo(e){let t,o,s,n=!1;return function(r){t===void 0?(t=r,o=0,s=-1):t=po(t,r);const l=t.length;let c=0;for(;o<l;){n&&(t[o]===10&&(c=++o),n=!1);let d=-1;for(;o<l&&d===-1;++o)switch(t[o]){case 58:s===-1&&(s=o-c);break;case 13:n=!0;case 10:d=o;break}if(d===-1)break;e(t.subarray(c,d),s),c=o,s=-1}c===l?t=void 0:c!==0&&(t=t.subarray(c),o-=c)}}function mo(e,t,o){let s=Ae();const n=new TextDecoder;return function(r,l){if(r.length===0)o==null||o(s),s=Ae();else if(l>0){const c=n.decode(r.subarray(0,l)),d=l+(r[l+1]===32?2:1),v=n.decode(r.subarray(d));switch(c){case"data":s.data=s.data?s.data+`
`+v:v;break;case"event":s.event=v;break;case"id":e(s.id=v);break;case"retry":const m=parseInt(v,10);isNaN(m)||t(s.retry=m);break}}}}function po(e,t){const o=new Uint8Array(e.length+t.length);return o.set(e),o.set(t,e.length),o}function Ae(){return{data:"",event:"",id:"",retry:void 0}}var go=function(e,t){var o={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(o[s]=e[s]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(o[s[n]]=e[s[n]]);return o};const ie="text/event-stream",ho=1e3,Pe="last-event-id";function _o(e,t){var{signal:o,headers:s,onopen:n,onmessage:a,onclose:r,onerror:l,openWhenHidden:c,fetch:d}=t,v=go(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((m,h)=>{const p=Object.assign({},s);p.accept||(p.accept=ie);let u;function g(){u.abort(),document.hidden||R()}c||document.addEventListener("visibilitychange",g);let b=ho,S=0;function P(){document.removeEventListener("visibilitychange",g),window.clearTimeout(S),u.abort()}o==null||o.addEventListener("abort",()=>{P(),m()});const $=d??window.fetch,q=n??yo;async function R(){var y;u=new AbortController;try{const O=await $(e,Object.assign(Object.assign({},v),{headers:p,signal:u.signal}));await q(O),await fo(O.body,vo(mo(T=>{T?p[Pe]=T:delete p[Pe]},T=>{b=T},a))),r==null||r(),P(),m()}catch(O){if(!u.signal.aborted)try{const T=(y=l==null?void 0:l(O))!==null&&y!==void 0?y:b;window.clearTimeout(S),S=window.setTimeout(R,T)}catch(T){P(),h(T)}}}R()})}function yo(e){const t=e.headers.get("content-type");if(!(t!=null&&t.startsWith(ie)))throw new Error(`Expected content-type to be ${ie}, Actual: ${t}`)}class bo{constructor(t={}){N(this,"onOpen");N(this,"onClose");N(this,"onError");N(this,"onMessage");N(this,"opt",{url:"",data:{}});N(this,"controller",new AbortController);this.opt={...this.opt,...t},this.open()}open(){const t=new FormData;for(const o in this.opt.data)Object.prototype.hasOwnProperty.call(this.opt.data,o)&&t.append(o,this.opt.data[o]);_o(this.opt.url,{method:"POST",signal:this.controller.signal,openWhenHidden:!0,body:t,onopen:async o=>{if(o.ok&&o.headers.get("content-type")===ie)typeof this.onOpen=="function"&&this.onOpen();else throw o.status>=400&&o.status<500&&o.status!==429?new Error("连接出错"):new Error("连接出错")},onmessage:o=>{typeof this.onMessage=="function"&&this.onMessage(o)},onclose:()=>{typeof this.onClose=="function"&&this.onClose(),this.controller.abort()},onerror:o=>{typeof this.onError=="function"&&this.onError(o)}})}abort(){this.controller.abort()}}const wo={avater:ge},ke=Ne("user",()=>ae({...wo}));function ko(e){const t=new FormData;return Object.keys(e).forEach(o=>{e[o]!==void 0&&e[o]!==null&&t.append(o,e[o])}),t}function Z(e=16,t=0){const o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s=[];let n;if(t=t||o.length,e)for(n=0;n<e;n++)s[n]=o[0|Math.random()*t];else{let a;for(s[8]=s[13]=s[18]=s[23]="-",s[14]="4",n=0;n<36;n++)s[n]||(a=0|Math.random()*16,s[n]=o[n==19?a&3|8:a])}return s.join("")}function et(){let e=Te.get("openid");return e||(e=Z(16),Te.set("openid",e)),e}function qe(e){return e.replace(/[&<"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case'"':return"&quot;";default:return"&#039;"}})}const Re=(e,t)=>t,tt=e=>{const t={t:a=>Re(e,a)};if(!xe)return t;const{t:o,...s}=xe.global;return{...s,t:(a,...r)=>a?!a.includes(".")&&!e?a:o(Re(e,a),...r):""}};function Co(e){const{t}=tt();let o=e.response.status,s=e.response.data.message||e.message,n="";switch(o){case 400:n=`${s}`;break;case 401:n=t("common.errMsg401");break;case 403:n=t("common.errMsg403");break;case 404:n=t("common.errMsg404");break;case 405:n=t("common.errMsg405");break;case 408:n=t("common.errMsg408");break;case 500:n=t("common.errMsg500");break;case 501:n=t("common.errMsg501");break;case 502:n=t("common.errMsg502");break;case 503:n=t("common.errMsg503");break;case 504:n=t("common.errMsg504");break;case 505:n=t("common.errMsg505");break;default:n=`${s}`}return n}let de=!1;function ot(e){de||(de=!0,le(e),setTimeout(()=>{de=!1},200))}const So=e=>{if(e.method==="post"&&e.headers["Content-Type"]==="application/x-www-form-urlencoded"?e.data=Lt.stringify(e.data):e.method==="post"&&e.headers["Content-Type"]==="multipart/form-data"&&(e.data=ko(e.data)),e.method==="get"&&e.params){let t=e.url;t+="?";const o=Object.keys(e.params);for(const s of o)e.params[s]!==void 0&&e.params[s]!==null&&(t+=`${s}=${encodeURIComponent(e.params[s])}&`);t=t.substring(0,t.length-1),e.params={},e.url=t}return e},Oo=e=>{var t,o,s;if(e.data&&typeof e.data.res<"u"&&(e.data.code=e.data.res,e.data.message=e.data.msg||""),((t=e==null?void 0:e.config)==null?void 0:t.responseType)==="blob")return e;if(e.data.code===ao)return e.data;if(le((o=e==null?void 0:e.data)==null?void 0:o.message),((s=e==null?void 0:e.data)==null?void 0:s.code)===401)ke().logout();else return Promise.reject(e.data)},To=e=>e.response?(console.log("response err： "+e),Mo(e)):e.request?(console.log("request err： "+e),xo(e)):Promise.reject(e),xo=e=>{var c,d,v;const{t}=tt(),{response:o,code:s,message:n}=e||{},a=((d=(c=o==null?void 0:o.data)==null?void 0:c.error)==null?void 0:d.message)??"",r=((v=e==null?void 0:e.toString)==null?void 0:v.call(e))??"";let l="";return s==="ECONNABORTED"&&n.indexOf("timeout")!==-1?l=t("common.apiTimeoutMessage"):r!=null&&r.includes("Network Error")?l=t("common.networkExceptionMsg"):l=a,ot(l),Promise.reject(e)},Mo=e=>{var s;let t=(s=e==null?void 0:e.response)==null?void 0:s.status,o=Co(e);return ot(o),t===401&&ke().logout(),Promise.reject(e)},Io="",K=new Map,Y=Et.create({timeout:lo,baseURL:Io});Y.interceptors.request.use(e=>{const t=new AbortController,o=e.url||"";return e.signal=t.signal,K.set(o,t),e});Y.interceptors.response.use(e=>{const t=e.config.url||"";return K.delete(t),e},e=>Promise.reject(e));Y.interceptors.request.use(So);Y.interceptors.response.use(Oo);Y.interceptors.response.use(void 0,To);const he={request:e=>new Promise((t,o)=>{var s;(s=e.interceptors)!=null&&s.requestInterceptors&&(e=e.interceptors.requestInterceptors(e)),Y.request(e).then(n=>{t(n)}).catch(n=>{o(n)})}),cancelRequest:e=>{var o;const t=Array.isArray(e)?e:[e];for(const s of t)(o=K.get(s))==null||o.abort(),K.delete(s)},cancelAllRequest(){for(const[e,t]of K)t.abort();K.clear()}},oe=e=>{const t=ke(),o=It(),{url:s,method:n,params:a,data:r,headers:l,responseType:c,withToken:d}=e,v=o.getCurrentLocale,m={"Content-Type":ro,"X-Requested-With":"XMLHttpRequest",lang:v.lang,...l};return d||(m.token=t.getToken??""),he.request({url:s,method:n,params:a,data:r,responseType:c,headers:{...m}})},ue={get:e=>oe({method:"get",...e}),post:e=>oe({method:"post",...e}),delete:e=>oe({method:"delete",...e}),put:e=>oe({method:"put",...e}),cancelRequest:e=>he.cancelRequest(e),cancelAllRequest:()=>he.cancelAllRequest()},Eo="",Lo=e=>new bo({url:Eo+"/chat/request",data:e}),Ao=e=>ue.post({url:"/chat/welcome",data:e}),Po=e=>ue.post({url:"/manage/getDialogueList",data:e}),qo=e=>ue.post({url:"/chat/message",data:e}),Ro=({id:e,prompt:t})=>ue.post({url:"/manage/editPrompt",data:{id:e,prompt:t}}),st=Ne("chat",()=>{const e=Ge(),t=_([]);let o=null;const s=_(0),n=_(""),a=ae({admin_user_id:"",avatar:"",id:"",name:"",nickname:"",openid:""}),r=ae({id:null,library_ids:"",prompt:"",robot_avatar:"",robot_intro:"",robot_key:"",robot_name:"",openid:"",welcomes:{content:"",question:[]}}),l=_(!1),c=async i=>{o&&(o.abort(),o=null),t.value=[],O.value=!1,u.value=!1,i.dialogue_id?(l.value=!1,s.value=i.dialogue_id):(l.value=!0,s.value=0),n.value=i.openid||et(),r.robot_key=i.robot_key,r.openid=n.value,a.openid=n.value,a.avatar=i.avatar||ge,a.name=i.name||"",a.nickname=i.nickname||"";const w=await Ao({robot_key:r.robot_key,openid:n.value,nickname:a.nickname,name:a.name,avatar:a.avatar||ge});try{const x=w.data.customer,f=w.data.robot;return a.admin_user_id=x.admin_user_id,a.avatar=x.avatar,a.id=x.id,a.name=x.name,a.nickname=x.nickname,r.library_ids=f.library_ids,r.prompt=f.prompt,r.robot_avatar=f.robot_avatar,r.robot_intro=f.robot_intro,r.robot_key=f.robot_key,r.robot_name=f.robot_name,r.library_ids=f.library_ids,r.id=f.id,f.welcomes&&(r.welcomes=JSON.parse(f.welcomes)),d(w.data.message),w}catch(x){Promise.reject(x)}},d=i=>{i&&(i.uid=Z(32),i.loading=!1,i.isWelcome=!0,i.avatar=r.robot_avatar,i.menu_json&&(i.menu_json=JSON.parse(i.menu_json)),i.quote_file&&(i.quote_file=JSON.parse(i.quote_file)),t.value.push(i))},v=i=>{i.uid=Z(32),i.loading=!1,i.avatar=a.avatar,i.openid=a.openid,i.msg_type=1,i.is_customer=1,t.value.push(i)},m=i=>{t.value.push(i),e.emit("updateAiMessage",i)},h=(i,w,x)=>{const f=t.value.findIndex(M=>M.uid==x);if(i=="sending"){const M=t.value[f].content;t.value[f].content=M+w}i=="quote_file"&&(t.value[f].quote_file=w.length>0?w:[]),i=="ai_message"&&(t.value[f].id=w.id),i=="debug"&&(t.value[f].debug=w.length>0?w:[]),e.emit("updateAiMessage",t.value[f])},p=()=>{const i=t.value.length-1;t.value[i].loading=!1},u=_(!1),g=i=>{if(u.value)return;const w={loading:!0,id:"",content:"",uid:Z(32),avatar:r.robot_avatar,msg_type:1,quote_file:[],is_customer:0,debug:[]},x={robot_key:r.robot_key,openid:r.openid,question:i.message,prompt:r.prompt,library_ids:r.library_ids,dialogue_id:s.value};u.value=!0,o=Lo(x),o.onMessage=f=>{if(f.event=="dialogue_id"&&(s.value=f.data),f.event=="c_message"){const M=JSON.parse(f.data);v(M)}if(f.event=="robot"&&(m(w),l.value&&(l.value=!1)),f.event=="sending"&&h("sending",f.data,w.uid),f.event=="ai_message"){const M=JSON.parse(f.data);h("ai_message",M,w.uid)}if(f.event=="quote_file"){const M=JSON.parse(f.data);h("quote_file",M,w.uid)}if(f.event=="debug"){const M=JSON.parse(f.data);h("debug",M,w.uid)}},o.onClose=()=>{p(),u.value=!1,o=null}},b=25,S=_([]),P=_(!1),$=_(!1),q=async()=>{if($.value||P.value)return!1;let i=0;S.value.length>0&&(i=S.value[S.value.length-1].id),P.value=!0;const w=await Po({min_id:i,size:b,robot_key:r.robot_key});P.value=!1;const x=w.data||[];return x.length===0?($.value=!0,!1):(S.value=[...S.value,...x],w)},R=async i=>await c(i),y=20,O=_(!1),T=async()=>{if(O.value)return;let i=0;const w=t.value.filter(f=>!f.isWelcome);w.length>0&&(i=w[0].id);const x={robot_key:r.robot_key,openid:a.openid,min_id:i,size:y,dialogue_id:s.value};try{const f=await qo(x),M=f.data.list||[];if(M.length===0){O.value=!0;return}return M.sort((L,nt)=>L.id-nt.id),M.forEach(L=>{L.loading=!1,L.uid=Z(32),L.is_customer==1?L.avatar=a.avatar:L.avatar=r.robot_avatar,L.menu_json&&(L.menu_json=JSON.parse(L.menu_json)),L.quote_file&&(L.quote_file=JSON.parse(L.quote_file))}),t.value=[...M,...t.value],f}catch(f){Promise.reject(f)}},k=i=>{r.prompt=i},B=()=>Ro({id:r.id,prompt:r.prompt});function D(){s.value=0,t.value=[],n.value="",a.admin_user_id="",a.avatar="",a.id="",a.name="",a.nickname="",a.openid="",r.id=null,r.library_ids="",r.prompt="",r.robot_avatar="",r.robot_intro="",r.robot_key="",r.robot_key="",r.robot_name="",r.openid="",r.welcomes={content:"",question:[]},l.value=!1,O.value=!1,u.value=!1,P.value=!1,$.value=!1,S.value=[]}return{$reset:D,user:a,robot:r,dialogue_id:s,openid:n,sendLock:u,messageList:t,createChat:c,sendMessage:g,getMyChatList:q,myChatList:S,openChat:R,onGetChatMessage:T,changeRobotPrompt:k,saveRobotPrompt:B}}),$o={class:"chat-header"},Bo={class:"chat-header-body"},jo=["src"],Fo={class:"robot-info"},Do={class:"robot-name"},No={class:"robot-intro"},zo=F({__name:"chat-header",setup(e){const t=st(),{robot:o}=ze(t),s=()=>{uo()};return(n,a)=>{const r=He("svg-icon");return E(),A("div",$o,[C(r,{class:"close-btn",name:"close",onClick:s}),I("div",Bo,[j(o).robot_avatar?(E(),A("img",{key:0,class:"avatar",src:j(o).robot_avatar,alt:""},null,8,jo)):pe("",!0),I("div",Fo,[I("div",Do,ee(j(o).robot_name),1),I("div",No,ee(j(o).robot_intro),1)])])])}}}),Ho=G(zo,[["__scopeId","data-v-fcea83b5"]]),Uo=["value","onKeydown"],fe=22,Vo=3,Ko=F({__name:"auto-size-textarea",props:{value:{type:String,default:""}},emits:["update:value","change","focus","blur","enter","shiftEnter"],setup(e,{emit:t}){const o=e,s=t,n=fe*Vo,a=_(null);function r(){s("focus")}function l(){s("blur")}function c(u){u.shiftKey||s("enter")}function d(u){var g=u.value,b=u.selectionStart;return b===g.length}function v(){if(a.value){const u=a.value.selectionStart,g=a.value.value.slice(0,u)+`
`+a.value.value.slice(u);a.value.value=g,d(a.value)&&(a.value.scrollTop=a.value.scrollHeight),a.value.setSelectionRange(u+1,u+1),p()}}function m(u){u.preventDefault(),v(),s("shiftEnter")}function h(u){const g=u.target;s("update:value",g.value),s("change",g.value),p()}function p(){a.value&&(a.value.style.height="auto",a.value.scrollHeight>n?a.value.style.height=`${n}px`:a.value.value.length==0?a.value.style.height=`${fe}px`:a.value.style.height=`${a.value.scrollHeight}px`)}return H(()=>o.value,()=>{!o.value&&a.value&&(a.value.style.height=`${fe}px`)}),ce(()=>{a.value&&p()}),(u,g)=>(E(),A("textarea",{class:"auto-size-textarea",rows:"1",ref_key:"textareaRef",ref:a,value:o.value,onInput:h,onFocus:r,onBlur:l,onKeydown:[Ce(Se(c,["prevent","exact"]),["enter"]),Ce(Se(m,["shift","prevent"]),["enter"])],placeholder:"在此输入，Shift+Enter换行"},null,40,Uo))}}),Wo=G(Ko,[["__scopeId","data-v-a17959af"]]),Jo={class:"message-input-box"},Go={class:"message-input-body"},Yo=F({__name:"message-input",props:{value:{type:String,default:""}},emits:["update:value","send"],setup(e,{emit:t}){const o=t,s=e,n=_(!1),a=l=>{o("update:value",l)},r=()=>{s.value.trim()&&o("send",s.value)};return(l,c)=>{const d=He("svg-icon");return E(),A("div",Jo,[I("div",Go,[I("div",{class:Ue(["message-input",{"is-focus":n.value}])},[C(Wo,{value:e.value,class:"text-input",onChange:a,onFocus:c[0]||(c[0]=v=>n.value=!0),onBlur:c[1]||(c[1]=v=>n.value=!1),onEnter:r},null,8,["value"]),C(d,{name:"paper-airplane",class:"send-btn",onClick:r})],2)])])}}}),Xo=G(Yo,[["__scopeId","data-v-a356030c"]]),Qo=F({__name:"message-list",props:{messages:{type:Array,default:()=>[]}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd"],setup(e,{expose:t,emit:o}){const s=o,n=e,a=_(null),r={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60};let l=null,c=!1;function d(){n.messages.length!=0&&s("scrollStart",{msg:n.messages[0]})}function v(){n.messages.length!=0&&s("scrollEnd",{msg:n.messages[n.messages.length-1]})}function m(u){c||(l!==null&&(clearTimeout(l),l=null),l=window.setTimeout(()=>{r.scrollTop=u.target.scrollTop,r.scrollHeight=u.target.scrollHeight,r.clientHeight=u.target.clientHeight,s("scroll",{...r}),Math.abs(r.scrollTop)<=r.scrollStartDiff&&d(),Math.abs(r.scrollHeight-r.scrollTop-r.clientHeight)<=r.scrollEndDiff&&v()},50))}const h=()=>{a.value&&me(()=>{c=!0,a.value&&(a.value.scrollTop=a.value.scrollHeight+1,setTimeout(()=>{c=!1},50))})};function p(u,g){me(()=>{c=!0,g||(g="top");let b=a.value,S=document.querySelector("#msg-"+u);!b||!S||(g=="top"?b.scrollTop=S.offsetTop:b.scrollTop=S.offsetTop-b.clientHeight+S.clientHeight,setTimeout(()=>{c=!1},50))})}return t({scrollToBottom:h,scrollToMessage:p}),(u,g)=>(E(),A("div",{class:"message-list",ref_key:"scrollBoxRef",ref:a,onScroll:m},[ft(u.$slots,"default",{},void 0)],544))}}),Zo=G(Qo,[["__scopeId","data-v-7e037515"]]),es=["id"],ts={class:"message-item-left"},os=["src"],ss={class:"message-item-body"},ns={class:"message-content"},as={key:0,class:"text-message"},rs={class:"text-message"},ls={key:0,class:"question-list"},is=["onClick"],cs=F({__name:"message-item",props:{msg:{type:Object,required:!0}},emits:["sendTextMessage"],setup(e,{emit:t}){const o=t,s=e,n=ve(()=>s.msg.is_customer==1),a=ve(()=>({"user-message-item":n.value===!0,"robot-message-item":n.value===!1,"welcome-message-item":s.msg.menu_json&&s.msg.menu_json.question})),r=l=>{o("sendTextMessage",l)};return(l,c)=>(E(),A("div",{class:Ue(["message-item",a.value]),id:"msg-"+e.msg.uid},[I("div",ts,[I("img",{class:"avatar",src:s.msg.avatar},null,8,os)]),I("div",ss,[I("div",ns,[s.msg.msg_type==1?(E(),A("div",as,ee(j(qe)(s.msg.content)),1)):s.msg.msg_type==2?(E(),A(se,{key:1},[I("div",rs,ee(j(qe)(s.msg.menu_json.content)),1),s.msg.menu_json&&s.msg.menu_json.question.length?(E(),A("div",ls,[(E(!0),A(se,null,Ve(s.msg.menu_json.question,d=>(E(),A("div",{class:"question-item",key:d,onClick:v=>r(d)},[I("span",null,ee(d),1)],8,is))),128))])):pe("",!0)],64)):pe("",!0)])])],10,es))}}),us=G(cs,[["__scopeId","data-v-db39b40c"]]),ds={class:"chat-page"},fs={class:"chat-page-header"},vs={class:"chat-page-body"},ms={class:"messages-list-wrap"},ps={class:"chat-page-footer"},gs=F({__name:"index",setup(e){const t=mt(),o=Ge(),s=st(),{sendMessage:n,openChat:a,onGetChatMessage:r,$reset:l}=s,{messageList:c,sendLock:d,dialogue_id:v,robot:m}=ze(s);let h=!0;const p=_(null),u=k=>{p.value&&p.value.scrollToMessage(k)},g=()=>{p.value&&h&&p.value.scrollToBottom()},b=async()=>{h=!1;let k=c.value[0].uid;await r()&&u(k)},S=()=>{},P=k=>{k.sdkFloatAvatar=io,co(k)},$=async()=>{h=!0;let k=t.query||{},B={robot_key:k.robot_key,avatar:k.avatar||"",name:k.name||"",nickname:k.nickname||"",openid:et(),dialogue_id:v.value};await a(B),await r()&&g(),P(pt(m.value))},q=_(""),R=k=>{if(!k)return le("请输入消息内容");n({message:k})},y=async()=>{if(!q.value)return le("请输入消息内容");h=!0,R(q.value),q.value=""},O=()=>{g()},T=()=>{g()};return ce(()=>{$(),o.on("updateAiMessage",O),o.on("openWindow",T)}),De(()=>{l()}),(k,B)=>(E(),A("div",ds,[I("div",fs,[C(Ho)]),I("div",vs,[I("div",ms,[C(Zo,{ref_key:"messageListRef",ref:p,messages:j(c),onScrollStart:b,onScrollEnd:S},{default:vt(()=>[(E(!0),A(se,null,Ve(j(c),D=>(E(),gt(us,{key:D.uid,msg:D,onSendTextMessage:R},null,8,["msg"]))),128))]),_:1},8,["messages"])])]),I("div",ps,[C(Xo,{value:q.value,"onUpdate:value":B[0]||(B[0]=D=>q.value=D),onSend:y,loading:j(d)},null,8,["value","loading"])])]))}}),Ss=G(gs,[["__scopeId","data-v-1f45216b"]]);export{Ss as default};
