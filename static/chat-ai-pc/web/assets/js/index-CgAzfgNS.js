import{u as K,_ as M,e as D,a as Q,s as R,D as X}from"./index.js";import{e as w,J as N,f as I,B as O,C as m,H as p,h as x,I as u,u as T,K as B,L,M as Y,r as b,w as Z,b as V,N as F,O as j,P as z,Q as ee,n as q,F as A,S as U,o as se,D as te,U as oe,V as ne,W as ae,A as le}from"./vue-chunks-BpMrDWVc.js";import"./axios-B4uVmeYG.js";import"./qs-DrHefV6n.js";import"./dayjs-C4iS2aBk.js";import"./crypto-js-BJ7SvduI.js";function J(c,i){if(i)try{i=JSON.parse(JSON.stringify(i))}catch(n){console.error("Failed to stringify data:",n);return}if(window.parent&&typeof window.parent.postMessage=="function")try{window.parent.postMessage({action:c,data:i},"*")}catch(n){console.error("Failed to post message:",n)}else console.warn("window.parent is not available or postMessage is not supported.")}function ce(c){J("init",c)}function ie(){J("closeChat")}const re={class:"chat-header-body"},ue=["src"],de={class:"robot-info"},ge={class:"robot-name"},me={class:"robot-intro"},pe=w({__name:"chat-header",setup(c){const i=K(),{externalConfigPC:n}=N(i),{headBackgroundColor:s}=n.value.pageStyle,a=I(()=>{const[t,r,l,d]=s.split(",");return t==="color"?l:`${t}(${r}, ${l}, ${d})`}),e=()=>{ie()};return(t,r)=>{const l=O("svg-icon");return m(),p("div",{class:"chat-header",style:Y({background:a.value})},[x(l,{class:"close-btn",name:"close",onClick:e}),u("div",re,[T(n).headImage?(m(),p("img",{key:0,class:"avatar",src:T(n).headImage,alt:""},null,8,ue)):B("",!0),u("div",de,[u("div",ge,L(T(n).headTitle),1),u("div",me,L(T(n).headSubTitle),1)])])],4)}}}),ve=M(pe,[["__scopeId","data-v-4b52de1f"]]),fe=["value","onKeydown"],H=22,_e=3,he=w({__name:"auto-size-textarea",props:{value:{type:String,default:""}},emits:["update:value","change","focus","blur","enter","shiftEnter"],setup(c,{emit:i}){const n=c,s=i,a=H*_e,e=b(null);function t(){s("focus")}function r(){s("blur")}function l(o){o.shiftKey||s("enter")}function d(o){var g=o.value,h=o.selectionStart;return h===g.length}function v(){if(e.value){const o=e.value.selectionStart,g=e.value.value.slice(0,o)+`
`+e.value.value.slice(o);e.value.value=g,d(e.value)&&(e.value.scrollTop=e.value.scrollHeight),e.value.setSelectionRange(o+1,o+1),S()}}function $(o){o.preventDefault(),v(),s("shiftEnter")}function y(o){const g=o.target;s("update:value",g.value),s("change",g.value),S()}function S(){e.value&&(e.value.style.height="auto",e.value.scrollHeight>a?e.value.style.height=`${a}px`:e.value.value.length==0?e.value.style.height=`${H}px`:e.value.style.height=`${e.value.scrollHeight}px`)}return Z(()=>n.value,()=>{!n.value&&e.value&&(e.value.style.height=`${H}px`)}),V(()=>{e.value&&S()}),(o,g)=>(m(),p("textarea",{class:"auto-size-textarea",rows:"1",ref_key:"textareaRef",ref:e,value:n.value,onInput:y,onFocus:t,onBlur:r,onKeydown:[F(j(l,["prevent","exact"]),["enter"]),F(j($,["shift","prevent"]),["enter"])],placeholder:"在此输入，Shift+Enter换行"},null,40,fe))}}),Te=M(he,[["__scopeId","data-v-663f5138"]]),ye={class:"message-input-box"},Se={class:"message-input-body"},xe=w({__name:"message-input",props:{value:{type:String,default:""}},emits:["update:value","send"],setup(c,{emit:i}){const n=i,s=c,a=b(!1),e=r=>{n("update:value",r)},t=()=>{s.value.trim()&&n("send",s.value)};return(r,l)=>{const d=O("svg-icon");return m(),p("div",ye,[u("div",Se,[u("div",{class:z(["message-input",{"is-focus":a.value}])},[x(Te,{value:c.value,class:"text-input",onChange:e,onFocus:l[0]||(l[0]=v=>a.value=!0),onBlur:l[1]||(l[1]=v=>a.value=!1),onEnter:t},null,8,["value"]),x(d,{name:"paper-airplane",class:"send-btn",onClick:t})],2)])])}}}),Me=M(xe,[["__scopeId","data-v-8f75943c"]]),we=w({__name:"message-list",props:{messages:{type:Array,default:()=>[]}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd"],setup(c,{expose:i,emit:n}){const s=n,a=c,e=b(null),t={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60};let r=null,l=!1;function d(){a.messages.length!=0&&s("scrollStart",{msg:a.messages[0]})}function v(){a.messages.length!=0&&s("scrollEnd",{msg:a.messages[a.messages.length-1]})}function $(o){l||(r!==null&&(clearTimeout(r),r=null),r=window.setTimeout(()=>{t.scrollTop=o.target.scrollTop,t.scrollHeight=o.target.scrollHeight,t.clientHeight=o.target.clientHeight,s("scroll",{...t}),Math.abs(t.scrollTop)<=t.scrollStartDiff&&d(),Math.abs(t.scrollHeight-t.scrollTop-t.clientHeight)<=t.scrollEndDiff&&v()},50))}const y=()=>{e.value&&q(()=>{l=!0,e.value&&(e.value.scrollTop=e.value.scrollHeight+1,setTimeout(()=>{l=!1},50))})};function S(o,g){q(()=>{l=!0,g||(g="top");let h=e.value,_=document.querySelector("#msg-"+o);!h||!_||(g=="top"?h.scrollTop=_.offsetTop:h.scrollTop=_.offsetTop-h.clientHeight+_.clientHeight,setTimeout(()=>{l=!1},50))})}return i({scrollToBottom:y,scrollToMessage:S}),(o,g)=>(m(),p("div",{class:"message-list",ref_key:"scrollBoxRef",ref:e,onScroll:$},[ee(o.$slots,"default",{},void 0)],544))}}),$e=M(we,[["__scopeId","data-v-87e9df55"]]),be=["id"],ke={class:"message-item-left"},Ce=["src"],He={class:"message-item-body"},Ie={class:"message-content"},Be=["innerHTML"],Le=["innerHTML"],Ae={key:0,class:"question-list"},Ee=["onClick"],De=w({__name:"message-item",props:{msg:{type:Object,required:!0}},emits:["sendTextMessage"],setup(c,{emit:i}){const n=i,s=c,a=I(()=>s.msg.is_customer==1),e=I(()=>({"user-message-item":a.value===!0,"robot-message-item":a.value===!1,"welcome-message-item":s.msg.menu_json&&s.msg.menu_json.question})),t=r=>{n("sendTextMessage",r)};return(r,l)=>(m(),p("div",{class:z(["message-item",e.value]),id:"msg-"+c.msg.uid},[u("div",ke,[u("img",{class:"avatar",src:s.msg.avatar},null,8,Ce)]),u("div",He,[u("div",Ie,[s.msg.msg_type==1?(m(),p("div",{key:0,class:"text-message",innerHTML:T(D)(s.msg.content)},null,8,Be)):s.msg.msg_type==2?(m(),p(A,{key:1},[u("div",{class:"text-message",innerHTML:T(D)(s.msg.menu_json.content)},null,8,Le),s.msg.menu_json&&s.msg.menu_json.question.length?(m(),p("div",Ae,[(m(!0),p(A,null,U(s.msg.menu_json.question,d=>(m(),p("div",{class:"question-item",key:d,onClick:v=>t(d)},[u("span",null,L(d),1)],8,Ee))),128))])):B("",!0)],64)):B("",!0)])])],10,be))}}),Re=M(De,[["__scopeId","data-v-73484b0a"]]),Fe=c=>(ne("data-v-7451b1b9"),c=c(),ae(),c),je={class:"chat-page"},qe={class:"chat-page-header"},Ke={class:"chat-page-body"},Ne={class:"messages-list-wrap"},Oe={class:"chat-page-footer"},Ve=Fe(()=>u("div",{class:"technical-support-text"},"由chatwiki提供软件支持",-1)),ze=w({__name:"index",setup(c){const i=Q(),n=K(),{sendMessage:s,onGetChatMessage:a,$reset:e}=n,{messageList:t,sendLock:r,robot:l}=N(n);let d=!0;const v=b(null),$=f=>{v.value&&v.value.scrollToMessage(f)},y=()=>{v.value&&d&&v.value.scrollToBottom()},S=async()=>{d=!1;let f=t.value[0].uid;await a()&&$(f)},o=()=>{},g=f=>{f.sdkFloatAvatar=X,ce(f)},h=async()=>{d=!0,await a()&&y(),g(oe(l.value))},_=b(""),E=f=>{if(!f)return R("请输入消息内容");s({message:f})},P=async()=>{if(!_.value)return R("请输入消息内容");d=!0,E(_.value),_.value=""},W=()=>{y()},G=()=>{y()};return V(()=>{h(),i.on("updateAiMessage",W),i.on("openWindow",G)}),se(()=>{e()}),(f,C)=>(m(),p("div",je,[u("div",qe,[x(ve)]),u("div",Ke,[u("div",Ne,[x($e,{ref_key:"messageListRef",ref:v,messages:T(t),onScrollStart:S,onScrollEnd:o},{default:te(()=>[(m(!0),p(A,null,U(T(t),k=>(m(),le(Re,{key:k.uid,msg:k,onSendTextMessage:E},null,8,["msg"]))),128))]),_:1},8,["messages"])])]),u("div",Oe,[x(Me,{value:_.value,"onUpdate:value":C[0]||(C[0]=k=>_.value=k),onSend:P,loading:T(r)},null,8,["value","loading"]),Ve])]))}}),Xe=M(ze,[["__scopeId","data-v-7451b1b9"]]);export{Xe as default};
